## –ü—Ä–æ–µ–∫—Ç ¬´–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ + ETL¬ª –¥–ª—è –∫–∏–Ω–æ—Ç–µ–∞—Ç—Ä–∞

–ê–¥–º–∏–Ω–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ –Ω–∞ **Django** –∏ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ª–µ–≥–∫–æ –∏ —É–¥–æ–±–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—É—â–Ω–æ—Å—Ç–∏ –∏ —Å–≤—è–∑–∏ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –∫–∏–Ω–æ—Ç–µ–∞—Ç—Ä–∞.  
–í —Ä–∞–º–∫–∞—Ö –ø—Ä–æ–µ–∫—Ç–∞ —Ç–∞–∫–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –Ω–µ–±–æ–ª—å—à–æ–π API, –≤–æ–∑–≤—Ä–∞—â–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ —Ñ–∏–ª—å–º–æ–≤ –≤ —Ñ–æ—Ä–º–∞—Ç–µ, –æ–ø–∏—Å–∞–Ω–Ω–æ–º –≤ [openapi-—Ñ–∞–π–ª–µ üíæ](/files/django_openapi.yml), –∏ –ø–æ–∑–≤–æ–ª—è—é—â–∏–π –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ–¥–Ω–æ–º –∏ –æ–±–æ –≤—Å–µ—Ö —Ñ–∏–ª—å–º–∞—Ö —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π.  
–¢–∞–∫–∂–µ –≤ —Ä–∞–º–∫–∞—Ö –ø—Ä–æ–µ–∫—Ç–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω —Å–µ—Ä–≤–∏—Å **ETL** –¥–ª—è –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ–≥–æ –ø–µ—Ä–µ–Ω–æ—Å–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Postgres –≤ Elasticsearch —Å–æ —Å–ª–µ–¥—É—é—â–∏–º–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–º–∏:  
- –°–µ—Ä–≤–∏—Å –≤–µ–¥–µ—Ç —Å–µ–±–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Å–≤—è–∑–∏ —Å ES –∏–ª–∏ Postgres. –ß—Ç–æ–±—ã —Å–µ—Ä–≤–∏—Å  –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –Ω–µ –º–µ—à–∞–ª –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—é –ë–î –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–µ—Ö–Ω–∏–∫–∞ backoff.
- –ü—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –æ–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å –º–µ—Å—Ç–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏, –∞ –Ω–µ –Ω–∞—á–∏–Ω–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–Ω–æ–≤–æ (—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ).
- –ü–µ—Ä–µ–Ω–æ—Å –¥–∞–Ω–Ω—ã—Ö –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è –∑–∞–¥–∞–Ω–Ω—ã–º–∏ –ø–æ—Ä—Ü–∏—è–º–∏, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å –±–∞–∑—ã –∏ —Å–µ—Ç—å.

## –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏

- –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ –Ω–∞ **Django**
- –í –∫–∞—á–µ—Å—Ç–≤–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **PostgreSQL**
- –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø–æ–¥ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º —Å–µ—Ä–≤–µ—Ä–∞ WSGI **Gunicorn**.
- –í –¥–ª—è –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **Elasticsearch**
- –î–ª—è –æ—Ç–¥–∞—á–∏ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **Nginx.**
- –í–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è –≤ **Docker**, –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ –º–µ–∂–¥—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏ —á–µ—Ä–µ–∑ **Docker Compose.**

## –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

1. **C–µ—Ä–≤–µ—Ä WSGI/ASGI** ‚Äî —Å–µ—Ä–≤–µ—Ä —Å –∑–∞–ø—É—â–µ–Ω–Ω—ã–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º.
2. **Nginx** ‚Äî –ø—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π —è–≤–ª—è–µ—Ç—Å—è —Ç–æ—á–∫–æ–π –≤—Ö–æ–¥–∞ –¥–ª—è web-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
3. **PostgreSQL** ‚Äî —Ä–µ–ª—è—Ü–∏–æ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–∞–Ω–Ω—ã—Ö.
4. **Elasticsearch** - –¥–≤–∏–∂–æ–∫ –∏ –±–∞–∑–∞ –¥–ª—è –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞.
5. **ETL** - —Å–µ—Ä–≤–∏—Å –¥–ª—è –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ–≥–æ –ø–µ—Ä–µ–Ω–æ—Å–∞ –¥–∞–Ω–Ω—ã—Ö –∏ –∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–∑ PostgreSQL –≤ Elasticsearch

## –°—Ö–µ–º–∞ —Å–µ—Ä–≤–∏—Å–∞

![all](images/all.png)

## –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

–ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ **Docker Compose.** 
–ü–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω—É–∂–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å—Ä–µ–¥—ã –≤ —Ñ–∞–π–ª–∞—Ö `.env.prod` (–¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∞–¥–º–∏–Ω–∫–∏) –∏ `.env.db.prod` (–¥–ª—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö).
–í –∫–∞—á–µ—Å—Ç–≤–µ –ø—Ä–∏–º–µ—Ä–∞ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –ª–µ–∂–∞—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ —Ñ–∞–π–ª—ã `.env.prod.sample` –∏ `.env.db.prod.sample`.  
–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ä–≤–∏—Å–∞ ETL —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ json-—Ñ–∞–π–ª–µ `postgres_to_es/config.json`. –î–ª—è ETL –º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–∞–º (`dsn`) Postgres –∏ Elastic, –∞ —Ç–∞–∫–∂–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∫–∞–∂–¥–æ–π –∏–∑ –±–∞–∑ (`min_backoff_delay` –∏ `max_backoff_delay` - –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–æ–π –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è), –∏–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–æ–≤—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –±–∞–∑–µ Postgres `sync_interval`, –∞ —Ç–∞–∫–∂–µ —Ä–∞–∑–º–µ—Ä "–ø–∞—á–∫–∏" –ø—Ä–∏ –ø–µ—Ä–µ–Ω–æ—Å–µ –¥–∞–Ω–Ω—ã—Ö `batch_size` –∏ –¥—Ä.    
–¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, –∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤—ã–≥–ª—è–¥–∏—Ç —Ç–∞–∫:

    $ cp .env.prod.sample .env.prod 
    $ cp .env.db.prod.sample .env.db.prod 
    {–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ —Ñ–∞–π–ª–∞—Ö –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–µ—Ä–≤–∏—Å–∞ ETL –≤ config.json} 
    $ docker-compose up -d --build 
    
 ## –ù–µ–º–Ω–æ–≥–æ –º—ã—Å–ª–µ–π –ø—Ä–æ ETL
 
### UPD  
–í–Ω–µ—Å –ø—Ä–∞–≤–∫–∏ –ø–æ —Ä–µ–≤—å—é, –æ–±–Ω–æ–≤–∏–ª –∞–ª–≥–æ—Ä–∏—Ç–º ETL - –∏–∑–±–∞–≤–∏–ª—Å—è –æ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã, –∏–∑–º–µ–Ω–∏–ª –∞–ª–≥–æ—Ä–∏—Ç–º –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–∞–∑—ã Postgres –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è, —É–¥–∞–ª–∏–ª —á–∞—Å—Ç—å —Å–∏–≥–Ω–∞–ª–æ–≤ (–æ—Å—Ç–∞–≤–∏–ª —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–∞–±–ª–∏—Ü m2m).  

  
#### –ü—Ä–µ–¥—ã–¥—É—â–∏–π –≤–∞—Ä–∏–∞–Ω—Ç
–í –ë–î —Å–æ–∑–¥–∞–Ω–∞ –æ—Ç–¥–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∞–ø–¥–µ–π—Ç–æ–≤ –∫–∏–Ω–æ–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–π, –ø–µ—Ä—Å–æ–Ω, –∂–∞–Ω—Ä–æ–≤ –∏ –∏—Ö —Å–≤—è–∑–µ–π. –î–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –æ—Ç—Å–ª–µ–¥–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ –∫–∏–Ω–æ–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–π, –Ω—É–∂–Ω–æ –∫–∞–∫ –≤–∞—Ä–∏–∞–Ω—Ç —É–¥–∞–ª—è—Ç—å –∏—Ö –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã, –Ω–µ —É–¥–∞–ª—è—è, –∞ –Ω–∞–ø—Ä–∏–º–µ—Ä –ø—Ä–æ—Å—Ç–∞–≤–ª—è—è —Ñ–ª–∞–∂–æ–∫ —É–¥–∞–ª–µ–Ω–Ω–æ—Å—Ç–∏, –ø–æ –∫–æ—Ç–æ—Ä–æ–º—É ETL –ø–æ–∑–∂–µ –±—ã –æ–ø—Ä–µ–¥–µ–ª—è–ª, —á—Ç–æ –∑–∞–ø–∏—Å—å –Ω–∞–¥–æ —É–¥–∞–ª–∏—Ç—å –∏ –∏–∑ –µ–≥–æ –±–¥. –ù–æ –≤ —ç—Ç–æ–º —Å–ª—É—á–∞–µ –ø—Ä–∏–ª–æ—Å—å –±—ã –∞–ø–¥–µ–π—Ç–∏—Ç—å –ª–æ–≥–∏–∫—É —Ä–∞–±–æ—Ç—ã —Å —Ç–∞–±–ª–∏—Ü–µ–π –∫–∏–Ω–æ–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–π, —á–µ–≥–æ –¥–µ–ª–∞—Ç—å –±—ã –Ω–µ —Ö–æ—Ç–µ–ª–æ—Å—å. –í —Ç–æ–º —á–∏—Å–ª–µ –ø–æ—ç—Ç–æ–º—É –±—ã–ª–æ –ø—Ä–∏–Ω—è—Ç–æ —Ä–µ—à–µ–Ω–∏–µ –∑–∞–≤–µ—Å—Ç–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∞–ø–¥–µ–π—Ç–æ–≤ –æ—Ç–¥–µ–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É.  
–° –ø–æ–º–æ—â—å—é —Å–∏–≥–Ω–∞–ª–æ–≤ –¥–∂–∞–Ω–≥–∏ –º—ã –¥–µ—Ç–µ–∫—Ç–∏–º –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–∏–Ω–æ–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–π, –ø–µ—Ä—Å–æ–Ω, –∂–∞–Ω—Ä–æ–≤ –∏ –∏—Ö —Å–≤—è–∑–µ–π, –æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ–∏–ª—å–º—ã, –∫–æ—Ç–æ—Ä—ã–µ —ç—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞—Ç—Ä–æ–Ω—É—Ç –∏ –æ–±–Ω–æ–≤–ª—è–µ–º/–¥–æ–±–∞–≤–ª—è–µ–º –≤ etl_updates `updated_at` —É —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–≥–æ —Ñ–∏–ª—å–º–∞. –î–∞–ª–µ–µ ETL –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ç —ç—Ç—É —Ç–∞–±–ª–∏—Ü—É –∏ –ø—Ä–∏ –ø–æ—è–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –æ–±–Ω–æ–≤–ª—è–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∏–ª—å–º–∞—Ö –≤ Elasticsearch'e.

